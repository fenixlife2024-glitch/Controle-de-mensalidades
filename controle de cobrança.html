<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cobran√ßa Pro - Integra√ß√£o ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #0f172a; color: #f8fafc; }
        .bg-dark-blue { background-color: #1e293b; }
        .text-orange { color: #f97316; }
        .bg-orange { background-color: #f97316; }
        .bg-orange:hover { background-color: #ea580c; }
        .border-orange { border-color: #f97316; }
    </style>
</head>
<body class="font-sans">

    <div class="flex min-h-screen">
        <aside class="w-64 bg-dark-blue p-6 border-r border-gray-700 hidden md:block">
            <h1 class="text-2xl font-bold text-orange mb-8 text-center italic">SISTEMA <span class="text-white">COBRAN√áA</span></h1>
            <nav class="space-y-4">
                <button onclick="renderizarTabela()" class="w-full text-left p-3 rounded bg-orange text-white font-bold shadow-lg shadow-orange/20"><i class="fas fa-home mr-2"></i> Dashboard</button>
                <button onclick="openModal('modalAluno')" class="w-full text-left p-3 rounded hover:bg-slate-700 transition"><i class="fas fa-plus mr-2"></i> Novo Aluno</button>
            </nav>
            <div class="mt-10">
                <label class="text-xs uppercase text-gray-500 font-black">Filtrar Unidade</label>
                <select id="filtroUnidade" onchange="renderizarTabela()" class="w-full mt-2 bg-slate-800 border border-gray-600 p-2 rounded text-sm outline-none focus:border-orange">
                    <option value="Todas">Todas as Unidades</option>
                    <option value="Recife">Recife</option>
                    <option value="Carpina">Carpina</option>
                    <option value="Gravat√°">Gravat√°</option>
                    <option value="Bezerros">Bezerros</option>
                    <option value="Amaraji">Amaraji</option>
                </select>
            </div>
        </aside>

        <main class="flex-1 p-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 text-center">
                <div class="bg-dark-blue p-5 rounded-lg border-b-4 border-orange">
                    <p class="text-gray-400 text-xs uppercase font-bold">Acordos Fechados</p>
                    <h3 id="cardFechados" class="text-3xl font-black text-orange">0</h3>
                </div>
                <div class="bg-dark-blue p-5 rounded-lg border-b-4 border-blue-500">
                    <p class="text-gray-400 text-xs uppercase font-bold">Propostas Enviadas</p>
                    <h3 id="cardEnviados" class="text-3xl font-black text-blue-400">0</h3>
                </div>
                <div class="bg-dark-blue p-5 rounded-lg border-b-4 border-red-500">
                    <p class="text-gray-400 text-xs uppercase font-bold">Em Atraso</p>
                    <h3 id="cardAtraso" class="text-3xl font-black text-red-500">0</h3>
                </div>
                <div class="bg-dark-blue p-5 rounded-lg border-b-4 border-green-500">
                    <p class="text-gray-400 text-xs uppercase font-bold">Em Dia</p>
                    <h3 id="cardEmDia" class="text-3xl font-black text-green-500">0</h3>
                </div>
            </div>

            <div class="bg-dark-blue rounded shadow-2xl overflow-hidden border border-gray-800">
                <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-slate-800/30">
                    <h2 class="font-bold text-lg">Negocia√ß√µes em Aberto</h2>
                    <input type="text" id="buscaGeral" onkeyup="renderizarTabela()" placeholder="Buscar nome ou CPF..." class="bg-slate-900 border border-gray-700 p-2 rounded text-sm w-72 outline-none focus:border-orange">
                </div>
                <table class="w-full text-left">
                    <thead class="bg-slate-800 text-xs uppercase text-gray-400 font-black">
                        <tr>
                            <th class="p-4">Aluno / CPF</th>
                            <th class="p-4">Unidade</th>
                            <th class="p-4">Status</th>
                            <th class="p-4">Vencimento</th>
                            <th class="p-4 text-center">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="listaAlunos" class="divide-y divide-gray-800"></tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="modalAluno" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-dark-blue w-full max-w-md p-6 rounded-lg border border-gray-700 shadow-2xl">
            <h2 class="text-xl font-bold text-orange mb-4">Novo Aluno</h2>
            <form id="formAluno" class="space-y-4">
                <div>
                    <label class="text-[10px] text-gray-400 font-bold uppercase">Nome do Aluno</label>
                    <input type="text" id="nome" required class="w-full bg-slate-900 border border-gray-700 p-2 rounded mt-1 uppercase outline-none focus:border-orange">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] text-gray-400 font-bold uppercase">CPF</label>
                        <input type="text" id="cpf" maxlength="14" placeholder="000.000.000-00" required class="w-full bg-slate-900 border border-gray-700 p-2 rounded mt-1 outline-none focus:border-orange">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-400 font-bold uppercase">WhatsApp</label>
                        <input type="text" id="tel" required class="w-full bg-slate-900 border border-gray-700 p-2 rounded mt-1 outline-none focus:border-orange">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] text-gray-400 font-bold uppercase">Unidade</label>
                        <select id="unidade" class="w-full bg-slate-900 border border-gray-700 p-2 rounded mt-1 outline-none">
                            <option value="Recife">Recife</option>
                            <option value="Carpina">Carpina</option>
                            <option value="Gravat√°">Gravat√°</option>
                            <option value="Bezerros">Bezerros</option>
                            <option value="Amaraji">Amaraji</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-400 font-bold uppercase">Tipo</label>
                        <select id="tipo" class="w-full bg-slate-900 border border-gray-700 p-2 rounded mt-1 outline-none">
                            <option value="Extranet">Extranet</option>
                            <option value="PTC">PTC</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-800">
                    <button type="button" onclick="closeModal('modalAluno')" class="text-gray-400 font-bold">Cancelar</button>
                    <button type="submit" class="bg-orange px-6 py-2 rounded font-black text-white uppercase text-sm">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalAcordo" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-dark-blue w-full max-w-md p-6 rounded-lg border-2 border-orange shadow-2xl">
            <h2 class="text-xl font-bold text-orange mb-1">Gerar Acordo</h2>
            <p id="nomeAlunoAcordo" class="text-xs text-gray-400 mb-6"></p>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] text-gray-400 font-bold uppercase">Valor √Ä Vista / Cart√£o (12x)</label>
                    <input type="text" id="valorAVista" onkeyup="maskDinheiro(this)" placeholder="R$ 0,00" class="w-full bg-slate-900 border border-gray-700 p-2 rounded text-orange font-bold outline-none focus:border-orange">
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 font-bold uppercase">Valor Total (Boleto)</label>
                    <input type="text" id="valorAcordo" onkeyup="maskDinheiro(this)" placeholder="R$ 0,00" class="w-full bg-slate-900 border border-gray-700 p-2 rounded font-bold outline-none focus:border-orange">
                </div>
                
                <div class="grid grid-cols-3 gap-2">
                    <div class="col-span-1">
                        <label class="text-[10px] text-gray-400 font-bold uppercase">Entrada</label>
                        <input type="text" id="entrada" onkeyup="maskDinheiro(this)" placeholder="R$ 0,00" class="w-full bg-slate-900 border border-gray-700 p-2 rounded outline-none">
                    </div>
                    <div class="col-span-1">
                        <label class="text-[10px] text-gray-400 font-bold uppercase">Parcelas</label>
                        <input type="number" id="numParcelas" value="1" class="w-full bg-slate-900 border border-gray-700 p-2 rounded outline-none">
                    </div>
                    <div class="col-span-1">
                        <label class="text-[10px] text-gray-400 font-bold uppercase">Vlr Parcela</label>
                        <input type="text" id="vlrParcelaManual" onkeyup="maskDinheiro(this)" placeholder="R$ 0,00" class="w-full bg-slate-900 border border-gray-700 p-2 rounded outline-none focus:border-orange text-orange font-bold">
                    </div>
                </div>

                <div class="flex items-center gap-2 bg-slate-800 p-3 rounded border border-gray-700">
                    <input type="checkbox" id="checkRematricula" class="w-5 h-5 accent-orange cursor-pointer">
                    <label for="checkRematricula" class="text-sm font-bold cursor-pointer">Incluir Rematr√≠cula (Emocional)</label>
                </div>

                <div class="flex justify-between gap-3 pt-4">
                    <button type="button" onclick="closeModal('modalAcordo')" class="text-gray-400 font-bold">Cancelar</button>
                    <button onclick="gerarEnviar()" class="bg-orange px-8 py-3 rounded font-black text-white uppercase text-xs shadow-lg">Gerar e Enviar Zap</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('cobranca_erp_v1')) || [];
        let idxAtivo = null;

        // M√°scaras
        document.getElementById('cpf').addEventListener('blur', function(e) {
            let v = e.target.value.replace(/\D/g, "");
            if (v.length > 0 && v.length < 11) v = v.padStart(11, '0');
            if (v.length === 11) {
                v = v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
                e.target.value = v;
            }
        });

        function maskDinheiro(i) {
            let v = i.value.replace(/\D/g,'');
            v = (v/100).toFixed(2) + '';
            v = v.replace(".", ",");
            v = v.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
            v = v.replace(/(\d)(\d{3}),/g, "$1.$2,");
            i.value = "R$ " + v;
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); idxAtivo = null; }

        document.getElementById('formAluno').addEventListener('submit', (e) => {
            e.preventDefault();
            db.push({
                nome: document.getElementById('nome').value.toUpperCase(),
                cpf: document.getElementById('cpf').value,
                tel: document.getElementById('tel').value,
                tipo: document.getElementById('tipo').value,
                unidade: document.getElementById('unidade').value,
                status: 'Pendente',
                fin: null
            });
            salvar();
            closeModal('modalAluno');
            e.target.reset();
        });

        function prepararAcordo(idx) {
            idxAtivo = idx;
            document.getElementById('nomeAlunoAcordo').innerText = "Aluno: " + db[idx].nome;
            openModal('modalAcordo');
        }

        function gerarEnviar() {
            const a = db[idxAtivo];
            const vAVista = document.getElementById('valorAVista').value;
            const vAcordo = document.getElementById('valorAcordo').value;
            const ent = document.getElementById('entrada').value;
            const parcNum = document.getElementById('numParcelas').value;
            const vParcMan = document.getElementById('vlrParcelaManual').value;
            const remat = document.getElementById('checkRematricula').checked;

            const dt = new Date();
            dt.setDate(dt.getDate() + 4);
            const venc = dt.toLocaleDateString('pt-BR');

            a.fin = { vAVista, vAcordo, ent, parcNum, vParcMan, venc, dataRef: dt.toISOString() };
            a.status = 'Enviado';

            let msg = "";
            const baseTexto = `‚úÖ *√Ä VISTA/CART√ÉO:* ${vAVista} (em at√© 12x iguais).\nüì¶ *PARCELADO NO BOLETO:* Total de ${vAcordo} sendo Entrada de ${ent} + ${parcNum} parcelas de ${vParcMan}.\n\n*Vencimento:* ${venc}.`;

            if(remat) {
                msg = `Ol√°, *${a.nome}*! Sentimos sua falta na unidade *${a.unidade}*. Seu sonho n√£o pode parar. Preparamos uma condi√ß√£o exclusiva:\n\nüöÄ ${baseTexto}\n\nCom a rematr√≠cula, sua plataforma volta em at√© 7 dias √∫teis. Vamos recome√ßar? Responda *SIM*.`;
            } else {
                msg = `Ol√°, *${a.nome}*. Temos uma proposta para regularizar suas pend√™ncias na unidade *${a.unidade}*:\n\n${baseTexto}\n\nBaixa nos sistemas em at√© 5 dias √∫teis. Responda *SIM* para fechar o acordo.`;
            }

            salvar();
            closeModal('modalAcordo');
            window.open(`https://api.whatsapp.com/send?phone=55${a.tel.replace(/\D/g,'')}&text=${encodeURIComponent(msg)}`);
        }

        function confirmar(idx) {
            if(confirm("Confirmar fechamento do acordo?")) {
                db[idx].status = 'Confirmado';
                salvar();
            }
        }

        function salvar() {
            localStorage.setItem('cobranca_erp_v1', JSON.stringify(db));
            renderizarTabela();
        }

        function renderizarTabela() {
            const lista = document.getElementById('listaAlunos');
            const filtroU = document.getElementById('filtroUnidade').value;
            const busca = document.getElementById('buscaGeral').value.toLowerCase();
            lista.innerHTML = "";

            let f = 0, e = 0, emD = 0, atr = 0;

            db.forEach((a, idx) => {
                if (filtroU !== "Todas" && a.unidade !== filtroU) return;
                if (busca && !a.nome.toLowerCase().includes(busca) && !a.cpf.includes(busca)) return;

                if(a.status === 'Confirmado') f++;
                if(a.status === 'Enviado') e++;

                let sBadge = `<span class="text-gray-500 font-bold">Pendente</span>`;
                if(a.status === 'Enviado') sBadge = `<span class="text-blue-400 font-bold">Proposta Enviada</span>`;
                if(a.status === 'Confirmado') sBadge = `<span class="text-orange font-black uppercase">‚óè Acordo Fechado</span>`;

                let dVenc = "---";
                if(a.fin) {
                    dVenc = a.fin.venc;
                    const diff = Math.floor((new Date(a.fin.dataRef) - new Date()) / (1000*60*60*24));
                    if(diff < 0 && a.status !== 'Confirmado') atr++;
                    else if (a.status === 'Confirmado') emD++;
                }

                lista.innerHTML += `
                    <tr class="hover:bg-slate-800 transition border-b border-gray-800">
                        <td class="p-4"><div class="font-bold">${a.nome}</div><div class="text-[10px] text-gray-500">${a.cpf}</div></td>
                        <td class="p-4 text-sm">${a.unidade}</td>
                        <td class="p-4 text-sm">${sBadge}</td>
                        <td class="p-4 text-sm">${dVenc}</td>
                        <td class="p-4 flex justify-center gap-4">
                            <button onclick="prepararAcordo(${idx})" class="text-orange" title="Proposta"><i class="fas fa-handshake fa-lg"></i></button>
                            <button onclick="confirmar(${idx})" class="text-green-500" title="Fechar"><i class="fas fa-check-double fa-lg"></i></button>
                            <button onclick="if(confirm('Excluir?')){db.splice(${idx},1); salvar();}" class="text-red-900"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });

            document.getElementById('cardFechados').innerText = f;
            document.getElementById('cardEnviados').innerText = e;
            document.getElementById('cardAtraso').innerText = atr;
            document.getElementById('cardEmDia').innerText = emD;
        }

        renderizarTabela();
    </script>
</body>
</html>
